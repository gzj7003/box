name: Run scrape_ips_1.py script automatically

on:
  schedule:
    - cron: '0 22 * * *'
    - cron: '0 7 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

# 设置权限（重要！）
permissions:
  contents: write

jobs:
  run-script:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Check out the code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        # 使用您在GitHub上设置的secret名称
        token: ${{ secrets.PAT_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable

    - name: Install dependencies
      run: |
        pip install requests selenium webdriver-manager

    - name: Run scrape_ips_1.py
      run: |
        cd ${{ github.workspace }}
        echo "当前工作目录: $(pwd)"
        echo "脚本路径: $(pwd)/pl10000/scrape_ips_1.py"
        python pl10000/scrape_ips_1.py

    - name: Check generated files
      run: |
        echo "=== 搜索所有生成的文件 ==="
        find . -name "*.txt" -type f
        
        echo "=== 工作空间根目录内容 ==="
        ls -la

    - name: Prepare files for commit
      run: |
        cd ${{ github.workspace }}
        
        # 确保zby.txt存在
        if [ -f "zbhb-pl10000.txt" ]; then
          echo "✅ 主文件 zbhb-pl10000.txt 存在"
          echo "文件大小: $(wc -l < zbhb-pl10000.txt) 行"
          
          # 复制主文件为zby.txt
          cp zbhb-pl10000.txt zby.txt
          echo "已将 zbhb-pl10000.txt 复制为 zby.txt"
        elif [ -f "zby.txt" ]; then
          echo "✅ zby.txt 已存在"
        else
          # 创建空的zby.txt
          echo "# 自动生成的直播源文件" > zby.txt
          echo "# 生成时间: $(date)" >> zby.txt
          echo "# 脚本未生成预期文件" >> zby.txt
        fi

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Commit and push
      run: |
        # 添加要提交的文件
        git add zby.txt zbhb-pl10000.txt zbhb1-pl10000.txt 2>/dev/null || true
        
        # 检查是否有更改
        if git diff --cached --quiet; then
          echo "没有更改需要提交"
        else
          echo "提交更改..."
          git commit -m "自动更新: 直播源数据 [$(date +'%Y-%m-%d %H:%M:%S')]"
          
          # 推送到仓库
          echo "推送更改..."
          git push origin HEAD:main
          echo "✅ 提交成功"
        fi

    - name: Final summary
      run: |
        echo "=== 工作流执行完成 ==="
        echo "生成的文件:"
        ls -la *.txt 2>/dev/null || echo "没有找到txt文件"
        
        if [ -f "zby.txt" ]; then
          echo "✅ zby.txt 已创建"
          echo "文件行数: $(wc -l < zby.txt)"
          echo "前5行内容:"
          head -5 zby.txt
        else
          echo "❌ zby.txt 未创建"
        fi
