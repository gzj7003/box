name: Run scrape_ips_1.py script automatically

on:
  schedule:
    - cron: '0 22 * * *'
    - cron: '0 7 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  run-script:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Check out the code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Chrome and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        pip install requests selenium webdriver-manager

    - name: Run script and create zby.txt
      run: |
        cd ${{ github.workspace }}
        
        # 运行脚本
        python pl10000/scrape_ips_1.py
        
        # 创建zby.txt
        if [ -f "zbhb-pl10000.txt" ]; then
          cp zbhb-pl10000.txt zby.txt
        else
          echo "# 自动生成" > zby.txt
          echo "# 时间: $(date)" >> zby.txt
        fi

    - name: Push using GitHub CLI (最简单的方法)
      run: |
        cd ${{ github.workspace }}
        
        # 使用GitHub CLI提交
        gh auth setup-git
        
        # 配置git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # 添加文件
        git add zby.txt
        
        # 提交并推送
        git commit -m "更新zby.txt [$(date +'%Y-%m-%d %H:%M:%S')]" || echo "没有更改"
        git push origin HEAD:main
        
        echo "✅ 完成"
      env:
        # 使用PAT token进行认证
        GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
