name: Scrape_1 IP Data

permissions:
  contents: write  # 授予写入权限

on:
  workflow_dispatch:  # 允许手动触发
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨2点自动运行 (UTC时间)

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium webdriver-manager chromedriver-autoinstaller
        
    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: Run scraper
      run: |
        cd ${{ github.workspace }}
        echo "当前工作目录: $(pwd)"
        echo "脚本路径: ${{ github.workspace }}/pl10000/scrape_ips_1.py"
        python pl10000/scrape_ips.py
        
    - name: List all generated files
      run: |
        echo "=== 搜索所有生成的文件 ==="
        find ${{ github.workspace }} -name "*.txt" -type f
        find ${{ github.workspace }} -name "*.png" -type f
        find ${{ github.workspace }} -name "*.html" -type f
        echo ""
        echo "=== 工作空间根目录内容 ==="
        ls -la ${{ github.workspace }}
        
    - name: Verify file existence
      run: |
        if [ -f "${{ github.workspace }}/zbhb1-pl10000.txt" ]; then
          echo "✅ 主文件 zbhb1-pl10000.txt 存在"
          echo "文件大小: $(wc -l < ${{ github.workspace }}/zbhb1-pl10000.txt) 行"
        else
          echo "❌ 警告: zbhb1-pl10000.txt 不存在"
          echo "检查脚本目录备份文件..."
          if [ -f "${{ github.workspace }}/pl10000/zbhb1-pl10000.txt" ]; then
            echo "✅ 在脚本目录找到备份文件"
            cp "${{ github.workspace }}/pl10000/zbhb1-pl10000.txt" "${{ github.workspace }}/"
          fi
        fi
        
    - name: Commit and push results
      if: always()
      run: |
        cd ${{ github.workspace }}
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        
        # 添加所有生成的文件
        git add zbhb1-pl10000.txt 2>/dev/null || echo "主文件不存在"
        git add pl10000/zbhb1-pl10000.txt 2>/dev/null || echo "备份文件不存在"
        
        # 检查是否有文件需要提交
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "Update: Scraped IP data [$(date +'%Y-%m-%d %H:%M')]"
          git push
          echo "✅ 文件已提交到仓库"
        else
          echo "⚠️  没有检测到文件变化"
        fi
        
    - name: Upload results as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ip-data
        path: |
          ${{ github.workspace }}/zbhb1-pl10000.txt
          ${{ github.workspace }}/pl10000/zbhb1-pl10000.txt
          ${{ github.workspace }}/*.png
          ${{ github.workspace }}/*.html
        retention-days: 7  # 保留7天
